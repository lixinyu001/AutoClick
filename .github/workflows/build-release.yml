name: Build Android Release APK

# 触发条件：手动触发 + 推代码到main分支时触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 配置JDK环境（Android项目常用JDK 17）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 3. 安装Gradle
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: 8.2

      # 4. 创建.android目录（关键步骤：避免keytool错误）
      - name: Create .android directory
        run: mkdir -p ~/.android

      # 5. 生成调试签名文件
      - name: Generate debug keystore
        run: |
          keytool -genkey -v \
            -keystore ~/.android/debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

      # 6. 构建Release版APK
      - name: Build Release APK
        run: gradle assembleRelease --stacktrace

      # 7. 上传APK到GitHub产物
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: autoclicker-release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      # 8. 显示APK信息
      - name: Display APK info
        run: |
          echo "=== APK Files ==="
          ls -lh app/build/outputs/apk/release/
          echo ""
          echo "=== APK Details ==="
          find app/build/outputs/apk/release/ -name "*.apk" -exec sh -c 'echo "File: $1"; unzip -l "$1" | head -20' _ {} \;
